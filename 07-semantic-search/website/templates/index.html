<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <title>Fetch Solr Documents</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
</head>

<body>

    <div class="search_bar">
        <div class="search-bar-logo">
            <h3 class="search-bar-title">
                <span class="first-letter">F</span>inding <span class="first-letter">O</span>ne <span class="first-letter">P</span>iece
            </h3>
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="One Piece Logo" class="one-piece-logo">
        </div>
        <input type="text" id="query-input" placeholder="Luffy loses battle">
        <button onclick="fetchDocuments()">
            <span class="search-text">Search</span>
        </button>
    </div>
    <div class="body-container">
        
        <div id="episode-list">
            <!-- Episode buttons will be added here -->
        </div>

        <div class="vertical-div">
            <img src="{{ url_for('static', filename='images/vertical.jpg') }}" alt="One Piece Characters" class="one-piece-vertical">
        </div>
    </div>
    <footer>
        <div class="footer-container">
            <div class="footer-left"><b>PRI Project</b></div>
            <div class="footer-right"><b>Made by: </b></div>
            <div>Hugo Castro, Marcos Costa, Rodrigo Moucho</div>
        </div>
        </div>
    </footer>

    <script>
        async function fetchDocuments() {
            const queryInput = document.getElementById('query-input').value.toLowerCase();
            const episodeListContainer = document.getElementById('episode-list');
            episodeListContainer.innerHTML = "Loading...";

            try {
                // Commented server-side fetch for testing purposes
                
                const response = await fetch('/fetch_documents', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: queryInput }),
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load episode data');
                }
                console.log(response)

                const data = await response.json();

                console.log(data)

                // Filter the data based on the query input
                const filteredData = data.response.docs.filter(episode =>
                    episode.title.toLowerCase().includes(queryInput)
                );

                if (filteredData.length === 0) {
                    episodeListContainer.innerHTML = "<p>No episodes found.</p>";
                    return;
                }

                // Create buttons for each episode
                episodeListContainer.innerHTML = '';
                filteredData.forEach(episode => {
                    const div = document.createElement('div');
                    div.className = 'episode-div';
                    div.innerHTML = `
                        <p class="episode-name">${episode.id}</b> - ${episode.title}</p>
                        <p class="episode-summary">${episode.short_summary}            
                        <div class="episode-details">
                        <p>${episode.rating} â˜† </p>
                        <p>${episode.air_date}</p>
                        </div>
                        `; 
                    div.onclick = () => {
                        window.location.href = `episode/${encodeURIComponent(episode.id)}`;
                    };
                    episodeListContainer.appendChild(div);
                });
            } catch (error) {
                episodeListContainer.innerHTML = `<p>Error: ${error.message}</p>`;
            }
        }
    </script>
</body>

</html>